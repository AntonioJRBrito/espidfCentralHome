<!DOCTYPE html>
<html>
  <head>
    <title>IA Solucoes</title>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/igra.css">
  </head>
  <body>
    <script src="/js/icons.js"></script>
    <script src="/js/messages.js"></script>
    <script>
      window.onload=function(){
        // permissão de acesso
        if(sessionStorage.getItem("autenticado")!=="sim"){window.location.href="index.html";return;}
        // variáveis
        const socket=new WebSocket(`ws://${location.host}/ws`);
        const index=document.getElementById("divIndex");
        const painel=document.getElementById("divPainel");
        let atuadores={};
        let sensores={};
        // comportamentos
        document.getElementById('btnCancelar').addEventListener("click",getCancel);
        document.getElementById('btnSalvar').addEventListener('click', sendAuto);
        socket.addEventListener('open',function(event){socket.send("LDM");});
        // funções
        function getCancel(){
          event.preventDefault();
          window.location.href=`index.html`;
        }
        function sendAuto(){
          const progItems=document.querySelectorAll('#divPainel .prog-item');
          const agendaData={};
          progItems.forEach(item=>{
            const sensorId=item.dataset.id;
            const actions=[];
            const progAutos=item.querySelectorAll('.prog-auto');
            progAutos.forEach(atuador=>{
              const checkbox=atuador.querySelector('input[type="checkbox"]');
              const btn=atuador.querySelector('.auto-dow-btn');
              if(checkbox.checked){
                actions.push({device_id:checkbox.id,action:btn.classList.contains('active')?1:0});
              }
            });
            if(actions.length>0){agendaData[sensorId]={actions};}
          });
          const jsonData=JSON.stringify(agendaData);
          if(socket.readyState===WebSocket.OPEN){socket.send("SVM:"+jsonData);}
          else{alert('Houve uma desconexão da Central, reinicie o processo!');}
          event.preventDefault();
          window.location.href = `index.html`;
        }
        function genAutoma(){
          painel.innerHTML='';
          for(const sensorId in sensores){
            const sensor=sensores[sensorId];
            const box=document.createElement('div');
            box.className='prog-item';
            box.id=sensorId;
            box.dataset.id=String(sensorId);
            const title=document.createElement('div');
            title.className='prog-title';
            title.textContent=sensor.name?sensor.name.slice(0,18):sensorId.slice(0,18);
            box.append(title);
            const automatedDevices={};
            for(const actDisp of sensor.actSense){automatedDevices[actDisp.idAct]=actDisp.statAct;}
            for(const deviceId in atuadores) {
              const device=atuadores[deviceId];
              const prog=document.createElement('div');
              prog.className='prog-auto';
              const label=document.createElement('label');
              label.className='custom-checkbox';
              const input=document.createElement('input');
              input.type='checkbox';
              input.id=deviceId;
              input.checked=automatedDevices[deviceId]!==undefined;
              const spanL=document.createElement('span');
              spanL.className='checkmark';
              label.appendChild(input);
              label.appendChild(spanL);
              prog.appendChild(label);
              const span=document.createElement('span');
              span.textContent=device.name.slice(0, 18);
              span.className='auto-class';
              prog.appendChild(span);
              const btn=document.createElement('button');
              btn.className='auto-dow-btn';
              if(automatedDevices[deviceId]===1){btn.classList.add('active');}
              btn.addEventListener('click',function(){this.classList.toggle('active');});
              prog.appendChild(btn);
              box.append(prog);
            }
            painel.appendChild(box);
          }
        }
        socket.onmessage=function(event){
          try{
            if(event.data.startsWith("keep")){
              socket.send("alive");
            }
            if(event.data.startsWith("sendData")){
              const data=JSON.parse(event.data.substring(8));
              atuadores={};
              for(const device of data["0"]){atuadores[device[0]]={id:device[0],name:device[1],type:device[2]};}
              sensores=data["1"];
              genAutoma();
            }
          }catch(e){console.error("Erro ao processar mensagem WS:",e);}
        };
        // inicialização
        index.style.display="flex";
        document.getElementById("iconSave").innerHTML=icons["save"];
        document.getElementById("iconCancelar").innerHTML=icons["exit"];
      };
    </script>
    <div id="divTopo" class="topo"><h2>Sistema de Automação</h2></div>
    <div id="divIndex" class="util">
      <div id="divPainel" class="in_util"></div>
      <div class="form-group">    
        <button type="button" id="btnSalvar" class="btn-custom"><span id="iconSave"></span>Salvar</button>
      </div>
      <div class="form-group">
        <button type="button" id="btnCancelar" class="btn-custom"><span id="iconCancelar"></span>Cancelar</button>
      </div>
    </div>
    <div class="rodape" id="divRodape"><img src="/img/logomarca" width="40px" height="40px"></div>
  </body>
</html>